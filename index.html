<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>
</head>
<body style="margin:0;padding:0;font-family:Arial,Helvetica,sans-serif;background:#fff;">
  <div style="max-width:560px;margin:48px auto;padding:24px;">
    <h1 style="margin:0 0 8px 0;">üîê Reset your password</h1>
    <p id="status" style="color:#444;margin:0 0 18px 0;">Checking link‚Ä¶</p>

    <div id="form" style="display:none;">
      <label style="display:block;margin:12px 0 6px;">New password</label>
      <input id="pw1" type="password" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;" />

      <label style="display:block;margin:12px 0 6px;">Confirm new password</label>
      <input id="pw2" type="password" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;" />

      <button id="btn" style="margin-top:16px;width:100%;padding:12px;border:0;border-radius:8px;background:#111;color:#fff;font-weight:700;">
        Reset password
      </button>

      <p style="font-size:12px;color:#777;margin-top:12px;line-height:1.4;">
        If you didn‚Äôt request this, just close this page.
      </p>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // ‚úÖ T√ñLTSD KI EZT!
    const SUPABASE_URL = "https://cgchcwqtevbybjxibamz.supabase.co";
    const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE";

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const qs = new URLSearchParams(window.location.search);
    const type = qs.get("type");
    const token_hash = qs.get("token_hash");

    const statusEl = document.getElementById("status");
    const formEl = document.getElementById("form");
    const btn = document.getElementById("btn");

    function fail(msg) {
      statusEl.textContent = msg;
      statusEl.style.color = "#b00020";
      formEl.style.display = "none";
    }

    function ok(msg) {
      statusEl.textContent = msg;
      statusEl.style.color = "#137333";
      formEl.style.display = "block";
    }

    // 1) Verify OTP using token_hash (NO PKCE!)
    if (type !== "recovery" || !token_hash) {
      fail("Missing token. Please use the newest reset email link.");
    } else {
      const { data, error } = await supabase.auth.verifyOtp({
        type: "recovery",
        token_hash
      });

      if (error) {
        console.error(error);
        fail("Invalid or expired link. Please request a new reset email.");
      } else {
        ok("Link OK. Choose a new password.");
      }
    }

    // 2) Update password
    btn?.addEventListener("click", async () => {
      const pw1 = document.getElementById("pw1").value;
      const pw2 = document.getElementById("pw2").value;

      if (!pw1 || !pw2) return alert("Fill both password fields.");
      if (pw1 !== pw2) return alert("Passwords do not match.");
      if (pw1.length < 8) return alert("Password must be at least 8 characters.");

      btn.disabled = true;
      btn.textContent = "Updating‚Ä¶";

      const { error } = await supabase.auth.updateUser({ password: pw1 });

      btn.disabled = false;
      btn.textContent = "Reset password";

      if (error) {
        console.error(error);
        alert("Failed: " + (error.message || "Unknown error"));
        return;
      }

      statusEl.textContent = "‚úÖ Password updated. You can return to the app and log in.";
      statusEl.style.color = "#137333";
      formEl.style.display = "none";
    });
  </script>
</body>
</html>
